<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<!-- TODO lazy import -> prpl pattern -->
<link rel="import" href="fragments/collections-view.html">

<dom-module id="ocean-eye-app">
  <template>
    <style>
      *, :host {
        box-sizing: border-box;
      }

      :host {
        --app-primary-color: darkslateblue;
        --app-negative-color: whitesmoke;
        --page-padding: 15px;
        display: block;
        font-family: 'Roboto', Arial, sans-serif;
      }

      app-header {
        color: var(--app-negative-color);
        background-color: var(--app-primary-color);
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: var(--app-negative-color);
      }

      iron-pages {
        padding: var(--page-padding);
      }
    </style>

    <app-location
        route="{{route}}"
        url-space-regex="^[[rootPath]]">
    </app-location>
    <app-route
        route="{{route}}"
        pattern="[[rootPath]]:page"
        data="{{routeData}}"
        tail="{{subroute}}">
    </app-route>
    <app-route
        route="{{subroute}}"
        pattern="/:subpage"
        data="{{subrouteData}}">
    </app-route>

    <app-header slot="header">
      <app-toolbar>
        <div main-title>Ocean Eye</div>
        <iron-selector attr-for-selected="icon" selected="{{page}}">
          <paper-icon-button icon="profile"></paper-icon-button>
          <paper-icon-button icon="logout"></paper-icon-button>
        </iron-selector>
      </app-toolbar>
    </app-header>

    <iron-pages
        selected="[[page]]"
        attr-for-selected="name">
      <collections-view
        name="collections"
        collection="{{collection}}"></collections-view>
      <profile-view name="settings"></profile-view>
      <play-view name="play"></play-view>
    </iron-pages>

  </template>

  <script>

    /**
     * Application wide constants
     *
     */
    const PAGE = {
      /**
       * @type {String}
       */
      COLLECTIONS: 'collections',
      /**
       * @type {String}
       */
      PLAY: 'play',
      /**
       * @type {String}
       */
      PROFILE: 'profile',
      /**
       * @type {String}
       */
      LOGOUT: 'logout',
    }
    const CUSTOMEVENTS = {
      /**
       * @type {String}
       */
      CHANGE_PAGE: 'changepage',
    }

    class OceanEyeApp extends Polymer.Element {
      static get is() { return 'ocean-eye-app'; }
      static get properties() {
        return {
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageChanged',
          },
          routeData: Object,
          subrouteData: Object,
          subroute: String,
          rootPath: String,
          /**
           * Collection selected (detected by subrouter)
           * @type {String}
           */
          collection: {
            type: String,
            value: '',
          }
        }
      }
      /**
       * Complex observers
       * (multi properties & property attributes)
       */
      static get observers() {
        return [
          '_routePageChanged(routeData.page)',
          '_subrouteChanged(subrouteData.subpage)',
        ];
      }
      /**
       * Listen to views' custom events
       */
      ready() {
        super.ready()
        // collections events listener
        // e.g. play page selected
        this.root.querySelector('collections-view')
                 .addEventListener(CUSTOMEVENTS.CHANGE_PAGE, e => {
          this.page = e.detail.page ? e.detail.page : this.page
        })
      }
      /**
       * Router observer
       *
       * @param {String} page
       */
      _routePageChanged(page) {
        if (page === PAGE.LOGOUT) {
          // redirect to logout page
          window.location = `${rootPath}/${PAGE.LOGOUT}`
        }
        // fallback to collections view on first loading
        this.page = page || PAGE.COLLECTIONS;
        // NOTE patch to reset the potentially selected collection
        // See: /fragments/collections-view.html
        if (this.subroute.path === ''
            && this.subroute.prefix === `/${PAGE.COLLECTIONS}`
            || page !== PAGE.COLLECTIONS) {
          this.collection = ''
        }
      }
      /**
       * Listen to subroute
       *
       * @param {String} subpage
       */
      _subrouteChanged(subpage) {
        // update selected collection to be propagated in collections-view
        if (this.page === PAGE.COLLECTIONS) {
          this.collections = subpage
        }
      }
      /**
       * Listen to page changes
       * Load fragment and save history state to enable
       * browser back/history button
       *
       * @param {String} page
       */
      _pageChanged(page) {
        Polymer.importHref(this._resolvedPageUrl(this.page), null, null, true)
        // Push state
        window.history.pushState({}, null, this.page)
        window.dispatchEvent(new CustomEvent('location-changed'))
      }
      /**
       * Map page value with fragment url path
       * @param {String} page
       * @return {String} url (relative)
       */
      _resolvedPageUrl(page) {
        // fallback on collections when page is not recognised
        switch (page) {
          case PAGE.PROFILE:
          case PAGE.PLAY:
            break;
          case PAGE.COLLECTIONS:
          default:
            page = PAGE.COLLECTIONS
        }
        return this.resolveUrl(`fragments/${page}-view.html`)
      }
    }

    window.customElements.define(OceanEyeApp.is, OceanEyeApp);
  </script>
</dom-module>
