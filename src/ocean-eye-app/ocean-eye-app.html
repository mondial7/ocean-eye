<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<!-- TODO lazy import -> prpl pattern -->
<link rel="import" href="fragments/collections-view.html">

<dom-module id="ocean-eye-app">
  <template>
    <style>
      *, :host {
        box-sizing: border-box;
        padding: 10px;
      }

      :host {
        --app-primary-color: #4285f4;
        --app-secondary-color: black;
        display: block;
        font-family: 'Roboto', Arial, sans-serif;
      }

      h1 {
        color: #333;
      }

      app-header {
        color: #fff;
        background-color: var(--app-primary-color);
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }
    </style>

    <app-location
        route="{{route}}"
        url-space-regex="^[[rootPath]]">
    </app-location>

    <app-route
        route="{{route}}"
        pattern="[[rootPath]]:page"
        data="{{routeData}}"
        tail="{{subroute}}">
    </app-route>

    <app-route
        route="{{subroute}}"
        pattern="/:subpage"
        data="{{subrouteData}}">
    </app-route>

    <app-header-layout fullbleed>

      <app-header slot="header" condenses reveals effects="waterfall">
        <app-toolbar>
          <div main-title>Ocean Eye</div>
          <div class="">
            <paper-icon-button icon="profile" on-tap="_hello"></paper-icon-button>
            <paper-icon-button icon="logout"></paper-icon-button>
          </div>
        </app-toolbar>
        <!-- <paper-tabs selected="{{page}}" attr-for-selected='name' role="navigation">
          <paper-tab name="projects" on-click="_backToProjectsList">Projects</paper-tab>
          <paper-tab name="profile">Profile</paper-tab>
          <paper-tab name="settings">Settings</paper-tab>
        </paper-tabs> -->
      </app-header>

      <iron-pages
          selected="[[page]]"
          attr-for-selected="name"
          fallback-selection="my-404"
          role="main">
        <collections-view
          name="collections"
          collection="{{collection}}"></collections-view>
        <settings-view name="settings"></settings-view>
        <my-404-view name="my-404"></my-404-view>
      </iron-pages>

    </app-header-layout>

  </template>

  <script>

    /**
     * Application wide constants
     *
     */
    const PAGE = {
      /**
       * @type {String}
       */
      COLLECTIONS: 'collections',
      /**
       * @type {String}
       */
      PLAY: 'play',
      /**
       * @type {String}
       */
      PROFILE: 'profile',
    }

    class OceanEyeApp extends Polymer.Element {
      static get is() { return 'ocean-eye-app'; }
      static get properties() {
        return {
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageChanged',
          },
          routeData: Object,
          subrouteData: Object,
          subroute: String,
          rootPath: String, // Polymer.Element#rootPath
          /**
           * Collection selected (detected by subrouter)
           * @type {String}
           */
          collection: {
            type: String,
            value: '',
          }
        }
      }
      /**
       * Complex observers
       * (multi properties & property attributes)
       */
      static get observers() {
        return [
          '_routePageChanged(routeData.page)',
          '_subrouteChanged(subrouteData.subpage)',
        ];
      }
      /**
       * Router observer
       *
       * @param {String} page
       */
      _routePageChanged(page) {
        // fallback to collections view on first loading
        this.page = page || PAGE.COLLECTIONS;

        // NOTE patch to reset the potentially selected collection
        // See: /fragments/collections-view.html
        if (this.subroute.path === ''
            && this.subroute.prefix === `/${PAGE.COLLECTIONS}`
            || page !== PAGE.COLLECTIONS) {
          this.collection = ''
        }
      }
      /**
       * Listen to subroute
       *
       * @param {String} subpage
       */
      _subrouteChanged(subpage) {
        // update selected collection to be propagated in collections-view
        if (this.page === PAGE.COLLECTIONS) {
          this.collections = subpage
        }
      }
      /**
       * Listen to page changes
       * Load fragment and save history state to enable
       * browser back/history button
       *
       * @param {String} page
       */
      _pageChanged(page) {
        Polymer.importHref(
            this._resolvedPageUrl(this.page),
            null,
            null,// e.g. this._showPage404.bind(this),
            true)
        // Push state
        window.history.pushState({}, null, this.page)
        window.dispatchEvent(new CustomEvent('location-changed'))
      }
      /**
       * Map page value with fragment url path
       * @param {String} page
       * @return {String} url (relative)
       */
      _resolvedPageUrl(page) {
        // fallback on collections when page is not recognised
        switch (page) {
          case PAGE.PROFILE:
          case PAGE.PLAY:
            break;
          case PAGE.COLLECTIONS:
          default:
            page = PAGE.COLLECTIONS
        }
        return this.resolveUrl(`fragments/${page}-view.html`)
      }
    }

    window.customElements.define(OceanEyeApp.is, OceanEyeApp);
  </script>
</dom-module>
