<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../../helpers/ocean-api.html">
<link rel="import" href="../../helpers/ocean-eye-config.html">
<link rel="import" href="./play/flipping-cards.html">
<link rel="import" href="./play/tuning-problem.html">
<!-- <link rel="import" href="./play/end-game.html"> -->

<dom-module id="play-view">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <ocean-api
      id="cardsAPI"
      endpoint="play/cards"
      response="{{informationitems}}"></ocean-api>

    <!-- TODO logger to store activities
    <ocean-api
      id="loggerAPI"
      endpoint="log/play"
      response="{{loggerStatus}}"></ocean-api> -->

    <iron-pages
        selected="[[_step]]"
        attr-for-selected="data-step">
      <flipping-cards id="first" data-step="1" cards="{{informationitems}}"></flipping-cards>
      <tuning-problem id="second" data-step="2" cards="{{informationitems}}"></tuning-problem>
      <!-- <end-game data-step="3"></end-game> -->
    </iron-pages>

  </template>

  <script>
    class PlayView extends Polymer.Element {
      static get is() { return 'play-view'; }
      static get properties() {
        return {
          /**
           * Status
           * @type {String}   standby or working
           */
          status: {
            type: String,
            value: 'standby',
          },
          /**
           * Steps
           * @type {Number}   1 or 2
           */
          _step: {
            type: Number,
            value: 1,
          },
          /**
           * Logs -> track user activity
           * @type {Array}
           */
          logs: {
            type: Array,
            value: () => [],
          },
          /**
           * InformationItems || Cards
           * @type {Array}
           */
          informationitems: {
            type: Array,
            value: () => [
              // TODO demo only
              {
                name: 'Churn Rate',
                summary: 'Proportion of customers who leave a supplier during a given time period',
                flipped: false,
              }
            ],
          },
        }
      }
      /**
       * Register event listeners
       */
      ready() {
        super.ready()
        this.$.cardsAPI.execute()
        // listen to items/cards updates
        this.$.first.addEventListener(CUSTOMEVENTS.UPDATE_ITEMS, e => {
          this._informationitemsUpdated(e.details)
        })
        // listen to player navigator
        this.$.first.addEventListener(CUSTOMEVENTS.PLAY_NAVIGATOR, e => {
          this._move(e.detail.step)
        })
        this.$.second.addEventListener(CUSTOMEVENTS.PLAY_NAVIGATOR, e => {
          this._move(e.detail.step)
        })
      }
      /**
       * Listen to information items update activity
       * @param {Object}   activity
       */
      _informationitemsUpdated(activity) {
        // update logs
        this.logs.push({ activity, time: new Date() })
      }
      /**
       * Navigate play steps
       * @param {String}   target step
       */
      _move(target) {
        switch (target) {
          case PLAY.END:
            // TODO close play session
            // TODO log activity
            break;
          case PLAY.TUNING:
            this._step = 2
            break;
          case PLAY.FLIPPING:
          default:
            this._step = 1
        }
      }

    }

    window.customElements.define(PlayView.is, PlayView);
  </script>
</dom-module>
